#!/bin/sh
#
# Pre-commit hook:
# 1) Ensures CI guard checks are not commented out in test files.
# 2) Prevents commits when Package.swift enables QUANTIZED_F16.
#
# Tests that are expensive or require network access use:
#   guard isGithubCI == false else { ... }
# to skip on CI. This hook prevents accidentally committing with those guards commented out.

# Check staged Package.swift for QUANTIZED_F16 define.
STAGED_PACKAGE_FILE=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^Package\.swift$')
if [ -n "$STAGED_PACKAGE_FILE" ]; then
  STAGED_PACKAGE_CONTENT=$(git show ":Package.swift")

  if echo "$STAGED_PACKAGE_CONTENT" | grep -q '\.define("QUANTIZED_F16")'; then
    echo "ERROR: QUANTIZED_F16 is enabled in staged Package.swift."
    echo "Commit rejected: remove '.define(\"QUANTIZED_F16\")' before committing."
    exit 1
  fi
fi

# Get list of staged .swift test files
STAGED_TEST_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^Tests/.*\.swift$')

if [ -z "$STAGED_TEST_FILES" ]; then
  exit 0
fi

FAILED=0

for FILE in $STAGED_TEST_FILES; do
  # Get the staged version of the file (what will actually be committed)
  STAGED_CONTENT=$(git show ":$FILE")

  # Check for commented-out CI guards (// before guard isGithubCI)
  COMMENTED_LINES=$(echo "$STAGED_CONTENT" | grep -n '^\s*//.*guard isGithubCI == false' || true)

  if [ -n "$COMMENTED_LINES" ]; then
    echo "ERROR: Commented-out CI guard found in $FILE:"
    echo "$COMMENTED_LINES"
    echo ""
    FAILED=1
  fi
done

if [ "$FAILED" -eq 1 ]; then
  echo "Commit rejected: CI guard checks must not be commented out."
  echo "Uncomment the 'guard isGithubCI == false else { ... }' blocks before committing."
  exit 1
fi

exit 0
